# 每日推荐功能使用说明

## 功能概述

每日推荐功能从网易云音乐的指定歌单中每天随机抽取10首歌曲,展示在首页的"每日推荐"栏目中。用户点击歌曲可以跳转到网易云音乐收听。

## 一、数据库表创建

首先需要创建数据库表,执行以下SQL:

```sql
CREATE TABLE IF NOT EXISTS h_daily_recommend (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL COMMENT '歌曲名称',
    artist VARCHAR(255) NOT NULL COMMENT '歌手名称',
    cover VARCHAR(500) COMMENT '封面图片URL',
    link_url VARCHAR(500) COMMENT '歌曲链接',
    badge VARCHAR(100) DEFAULT '热度爆表' COMMENT '标签（如:热度爆表）',
    recommend_date DATE NOT NULL COMMENT '推荐日期',
    sort_no INT DEFAULT 0 COMMENT '排序号',
    status INT DEFAULT 1 COMMENT '状态:1-启用,0-禁用',
    created_at TIMESTAMP DEFAULT CURRENT_timestamp COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_recommend_date (recommend_date),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='每日推荐表';
```

手动执行方法:
1. 打开MySQL客户端或数据库管理工具
2. 选择数据库 `HP_hiphop`
3. 执行上述SQL语句

或者使用命令行:
```bash
# 在项目目录下执行
mysql -uroot -p123 HP_hiphop -e "source src/main/resources/sql/create_daily_recommend_table.sql"
```

## 二、后端部分

### 1. 已创建的文件

- **实体类**: `HDailyRecommend.java` - 每日推荐数据实体
- **Mapper**: `HDailyRecommendMapper.java` 和 `HDailyRecommendMapper.xml`
- **Service**: `HDailyRecommendService.java` 和 `HDailyRecommendServiceImpl.java`
- **Controller**: `HDailyRecommendController.java`

### 2. 核心功能

#### 自动抓取歌曲
- 从网易云歌单获取所有歌曲ID
- 随机选择指定数量的歌曲
- 批量获取歌曲详情(歌名、歌手、封面)
- 保存到数据库

#### API接口

**获取最新推荐** (前台使用)
```
GET /api/home/daily/latest?limit=10
```

**分页查询推荐列表** (后台管理)
```
GET /api/home/daily?page=1&size=10&title=xxx&status=1
```

**手动触发抓取**
```
POST /api/home/daily/fetch?playlistId=5205824122&count=10
```

**新增推荐**
```
POST /api/home/daily
Body: {
  "title": "歌曲名",
  "artist": "歌手名",
  "cover": "封面URL",
  "linkUrl": "歌曲链接",
  "badge": "热度爆表",
  "recommendDate": "2025-12-19",
  "sortNo": 0,
  "status": 1
}
```

**更新推荐**
```
PUT /api/home/daily/{id}
```

**删除推荐**
```
DELETE /api/home/daily/{id}
```

**更新状态**
```
PATCH /api/home/daily/{id}/status?status=1
```

### 3. 启动后端服务

```bash
cd hiphop-home-admin
mvn clean compile
mvn spring-boot:run
```

## 三、前端部分

### 1. 后台管理页面

访问路径: `/admin/home/daily`

功能:
- **抓取推荐**: 点击"抓取推荐"按钮,从网易云歌单随机抽取10首歌曲
- **新增推荐**: 手动添加推荐歌曲
- **编辑**: 修改推荐信息
- **删除**: 删除推荐
- **状态开关**: 启用/禁用推荐
- **搜索**: 按标题和状态筛选

### 2. 前台展示页面

在首页 (BuzzIndex.vue) 的"每日推荐"栏目中展示

- 自动从后端API获取最新10条推荐
- 显示封面、歌名、歌手、标签、日期
- 点击可跳转到网易云音乐收听

### 3. 启动前端

```bash
cd hiphop-web
npm install
npm run dev
```

## 四、使用流程

### 方式一:自动抓取(推荐)

1. 启动后端服务
2. 访问后台管理页面 `http://localhost:5173/admin/home/daily`
3. 点击"抓取推荐"按钮
4. 确认后,系统会自动从网易云歌单抓取10首随机歌曲
5. 抓取完成后,前台首页即可看到最新推荐

### 方式二:手动添加

1. 在后台管理页面点击"新增推荐"
2. 填写歌曲信息:
   - 标题(必填)
   - 艺人(必填)
   - 封面图片URL(必填)
   - 跳转链接
   - 标签(默认"热度爆表")
   - 日期
   - 排序号
   - 状态
3. 点击"确定"保存

## 五、配置说明

### 修改歌单ID

默认歌单ID为 `5205824122`,如需更换:

1. 找到网易云音乐歌单,复制歌单ID
2. 修改两处代码:

**后端控制器** (`HDailyRecommendController.java`)
```java
@PostMapping("/fetch")
public Map<String, Object> fetchDaily(
        @RequestParam(defaultValue = "你的歌单ID") String playlistId,
        @RequestParam(defaultValue = "10") int count) {
    // ...
}
```

**前端管理页面** (`DailyRecommendAdmin.vue`)
```typescript
fetchDailyFromPlaylist('你的歌单ID', 10)
```

### 修改抓取数量

在后台管理页面的"抓取推荐"功能中,默认抓取10首,可以在代码中修改:

```typescript
fetchDailyFromPlaylist('5205824122', 15) // 改为15首
```

## 六、定时任务(可选)

如需每天自动抓取推荐,可以添加定时任务:

1. 在 `HDailyRecommendServiceImpl.java` 添加定时任务注解:

```java
import org.springframework.scheduling.annotation.Scheduled;

@Service
public class HDailyRecommendServiceImpl extends ServiceImpl<HDailyRecommendMapper, HDailyRecommend> 
        implements HDailyRecommendService {
    
    // 每天凌晨1点执行
    @Scheduled(cron = "0 0 1 * * ?")
    public void scheduleFetchDaily() {
        log.info("开始执行每日推荐自动抓取...");
        int count = fetchDailyRecommend("5205824122", 10);
        log.info("每日推荐抓取完成,共{}首歌曲", count);
    }
    
    // 原有方法...
}
```

2. 在主应用类启用定时任务:

```java
@SpringBootApplication
@EnableScheduling  // 添加这个注解
public class HomeAdminApplication {
    public static void main(String[] args) {
        SpringApplication.run(HomeAdminApplication.class, args);
    }
}
```

## 七、测试步骤

1. **创建数据库表**
   ```sql
   -- 执行 create_daily_recommend_table.sql
   ```

2. **启动后端**
   ```bash
   cd hiphop-home-admin
   mvn spring-boot:run
   ```

3. **启动前端**
   ```bash
   cd hiphop-web
   npm run dev
   ```

4. **访问后台管理**
   - 打开 `http://localhost:5173/admin/home/daily`
   - 点击"抓取推荐"按钮
   - 等待抓取完成

5. **查看前台效果**
   - 打开 `http://localhost:5173/buzz`
   - 在"每日推荐"栏目查看新抓取的歌曲

## 八、常见问题

### 1. 抓取失败

**原因**: 网易云API访问受限或歌单ID错误

**解决**:
- 检查歌单ID是否正确
- 确认网络连接正常
- 检查后端日志查看详细错误信息

### 2. 封面图片不显示

**原因**: 图片URL失效或跨域问题

**解决**:
- 检查图片URL是否有效
- 确认图片代理配置正常

### 3. 日期显示异常

**原因**: 日期格式或时区问题

**解决**:
- 确认数据库中的 `recommend_date` 字段格式正确
- 检查前端日期格式化代码

## 九、API测试示例

使用 Postman 或 curl 测试:

### 抓取推荐
```bash
curl -X POST "http://localhost:8080/api/home/daily/fetch?playlistId=5205824122&count=10"
```

### 获取最新推荐
```bash
curl "http://localhost:8080/api/home/daily/latest?limit=10"
```

### 新增推荐
```bash
curl -X POST "http://localhost:8080/api/home/daily" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "测试歌曲",
    "artist": "测试歌手",
    "cover": "https://example.com/cover.jpg",
    "linkUrl": "https://music.163.com/song?id=123456",
    "badge": "热度爆表",
    "recommendDate": "2025-12-19",
    "sortNo": 0,
    "status": 1
  }'
```

## 十、注意事项

1. 每次抓取会清空当天已有的推荐,避免重复
2. 歌单中的歌曲数量要大于抓取数量(至少10首)
3. 建议使用公开的、歌曲数量较多的歌单
4. 封面图片建议使用网易云自带的图片URL
5. 如果网易云API访问受限,可以考虑添加延迟或使用代理

---

**开发完成时间**: 2025-12-19
**版本**: v1.0
